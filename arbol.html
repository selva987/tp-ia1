<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TP IA 1 A*</title>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/all.min.css">

    <script src="js/vis-network.min.js"></script>
    <script src="js/jquery-3.5.0.min.js"></script>
    <script src="js/bootstrap.bundle.min.js"></script>


</head>
<body>
<header>
    <nav class="navbar navbar-dark bg-dark shadow-sm">
        <div class="container d-flex justify-content-between">
            <a href="#" class="navbar-brand d-flex align-items-center">
                <strong>Búsqueda A<sup>*</sup></strong>
            </a>
            <ul class="navbar-nav mr-auto">
                <li class="nav-item active">
                    <span id="labelAyuda" class="nav-link">Click derecho sobre el area para ver acciones</span></span>
                </li>
            </ul>
            <ul class="nav justify-content-end">
                <li class="nav-item">
                    <button type="button" class="btn btn-outline-light" onclick="calcularRuta();">Calcular ruta</button>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false"><i class="fas fa-cog"></i></a>
                    <div class="dropdown-menu">
                        <div class="dropdown-item">
                            <span>Opciones</span>
                        </div>
                        <div class="dropdown-divider"></div>
                        <div class="dropdown-item">
                            <div class="custom-control custom-switch d-flex justify-content-between">
                                <input type="checkbox" class="custom-control-input" id="switchCalcularH" onclick="setCalcularH(this.checked)">
                                <label class="custom-control-label" for="switchCalcularH">Calcular h'</label>
                            </div>
                        </div>
                    </div>
                </li>
            </ul>
        </div>
    </nav>
</header>

    <div id="grafo" style="width: 100%;height: 100%"></div>

<div class="dropdown-menu dropdown-menu-sm" id="context-menu">
    <a id="agregar-nodo" class="dropdown-item" href="#" onclick="agregarNodo();">Agregar nodo</a>
    <a id="eliminar-nodo" class="dropdown-item" href="#" onclick="network.deleteSelected()">Eliminar nodo</a>
    <a id="marcar-inicio" class="dropdown-item" href="#" onclick="marcarInicio()">Marcar como inicio</a>
    <a id="marcar-fin" class="dropdown-item" href="#" onclick="marcarFin()">Marcar como fin</a>
    <a id="agregar-camino" class="dropdown-item" href="#" onclick="setLabel('Arrastre desde y hacia el nodo que quiera conectar');network.addEdgeMode()">Agregar camino</a>
    <a id="eliminar-camino" class="dropdown-item" href="#" onclick="network.deleteSelected()">Eliminar camino</a>
</div>

<script>

    //Opciones generales de la aplicación
    var opciones = {
        calcularH: false
    };

    //Cuando se presiona suprimir, se elimina lo que haya seleccionado
    $(document).keyup(function(ev) {
        if(ev.keyCode == 46) {
            network.deleteSelected();
        }
    });

    var menuX;
    var menuY;

    var colorComun = {
        border: '#2B7CE9',
        background: '#97C2FC',
        highlight: {
            border: '#2B7CE9',
            background: '#D2E5FF'
        }
    };

    var colorInicio = {
        border: '#f5c6cb',
        background: '#f8d7da',
        highlight: {
            border: '#dc3545',
            background: '#dc3545'
        }
    };

    var colorFin = {
        border: '#c3e6cb',
        background: '#d4edda',
        highlight: {
            border: '#28a745',
            background: '#28a745'
        }
    };

    // ejemplo de nodos
    var nodes = new vis.DataSet([
        {id: 1, label: 'A'},
        {id: 2, label: 'B'},
        {id: 3, label: 'C'},
        {id: 4, label: 'D'},
        {id: 5, label: 'E'}
    ]);

    // ejemplo de caminos
    var edges = new vis.DataSet([
        {from: 1, to: 3, label: "30", color:"#5b5bff"},
        {from: 1, to: 2,label: "15", color: "#5b5bff"},
        {from: 2, to: 4,label: "100", color: "#5b5bff"},
        {from: 2, to: 5,label: "50", color: "#5b5bff"},
    ]);

    //Configuracion de la libreria
    var options = {
        autoResize: true,
        height: '100%',
        width: '100%',
        locale: 'es',
        // locales: locales,
        clickToUse: false,
        // configure: {enabled:true},    // defined in the configure module.
        edges: {
            color: {
                inherit: false,
                color:'#848484',
                highlight:'#848484',
            }
        },        // defined in the edges module.
        // nodes: {...},        // defined in the nodes module.
        // groups: {...},       // defined in the groups module.
        layout: {
            hierarchical: {
                direction: 'UD',
                sortMethod: "directed"
            }
        },       // defined in the layout module.
        // interaction: {...},  // defined in the interaction module.
        manipulation: {
            enabled: false,
            initiallyActive: false,
            addNode: function (node, callback) {
                //codigo legacy a menos que quisieramos utilizar botones
                setLabel('');
                let label = getLetraDisponible();
                if(label == null) return false;
                node.label = label;
                callback(node);
            },
            addEdge: function (edge, callback) {
                setLabel('');
                let peso = null;
                let arrNombre = [edge.from, edge.to];

                while(peso == null) {
                    peso = prompt('Ingrese el peso de la ruta, solo se admiten números enteros', 0);
                    if(!peso || peso == '0') {
                        network.disableEditMode();
                        return false;
                    }

                    peso = parseInt(peso);

                    if(!Number.isInteger(peso)) {
                        peso = null;
                    }
                }

                edge.label = peso.toString();
                edge.peso = peso;
                edge.id = arrNombre.sort().join('');

                if(data.edges.get(edge.id)) {
                    alert('Los nodos ya están conectados');
                    network.disableEditMode();
                    return false;
                }

                callback(edge);
            },
            editEdge: true,
            deleteNode: true,
            deleteEdge: true,
            controlNodeStyle:{
                // all node options are valid.
            }
        },
        // physics: {...},      // defined in the physics module.
        physics: {
            enabled: false,     // Stops node movement during display
            stabilization: {    // Determines an initial layout; enabled by default
                enabled: true,
                iterations: 1000
            }
        },
    };

    //Se inicializa la librería que va a servir para ingresar datos
    var container = document.getElementById('grafo');
    var data = { //ejemplo
        nodes: nodes,
        edges: edges
    };
    // var data = {
    //     nodes: new vis.DataSet(),
    //     edges: new vis.DataSet()
    // };
    var network = new vis.Network(container, data, options);


    //Manejo del menu contextual que hicimos
    network.on("oncontext", function (params) {
        params.event.preventDefault();
        $('#context-menu a').hide();

        //Depende de donde se clickeo se va a seleccionar lo que haya y mostrar
        //las opciones adecuadas en el menu
        let nodoID = network.getNodeAt(params.pointer.DOM);
        if(typeof nodoID !== 'undefined') {
            network.selectNodes([nodoID]);
            $('#agregar-camino').show();
            $('#eliminar-nodo').show();
            $('#marcar-inicio').show();
            $('#marcar-fin').show();
        } else {
            let rutaID = network.getEdgeAt(params.pointer.DOM);
            if(typeof rutaID !== 'undefined') {
                network.selectEdges([rutaID]);
                $('#eliminar-camino').show();
            } else {
                $('#agregar-nodo').show();
                $('#agregar-camino').show();
            }
        }

        //Guardo las coordenadas para usarlas en otras funciones
        menuX = params.pointer.canvas.x;
        menuY = params.pointer.canvas.y;

        //Acomodo el menu donde tiene que ir y lo muestro
        $("#context-menu").finish().toggle(100);
        $("#context-menu").css({
            top: params.event.pageY + "px",
            left: params.event.pageX + "px"
        });
    });

    //Si hago click en otro lado escondo el menu
    network.on("click", function(params) {
        $("#context-menu").removeClass("show").hide();
    });
    $(document).on("click", function() {
        $("#context-menu").removeClass("show").hide();
    });


    function getLetraDisponible() {
        for(i=65;i<97;i++) {
            label = String.fromCharCode(i);
            let disponible = true;
            data.nodes.forEach(function(e) {
                if(e.id == label) {
                    disponible = false;
                    return false;
                }
            });
            if(disponible) return label;
        }
        return null

    }

    function getNodoByID(id) {
        let nodo = null;
        data.nodes.forEach(function(e) {
            if(e.id == id) {
                nodo = e;
            }
        });

        return nodo;
    }

    function agregarNodo() {
        let label = getLetraDisponible();
        let h = prompt('Ingrese H', 0);

        if(h == null) return;
        let nodo = {
            id: label,
            label: label + ': ' + h,
            x: menuX,
            y: menuY,
            h: parseInt(h)
        }
        data.nodes.add(nodo);
    }

    function marcarInicio() {
        let nodoSeleccionado = network.getSelectedNodes();
        let nodos = data.nodes.get();
        if(nodos.length > 0) {
            nodos.forEach(function (e) {
                e.inicio = false;
                if(!e.fin) {
                    e.color = colorComun;
                }
            });
        }

        data.nodes.update(nodos);

        if(nodoSeleccionado.length > 0) {
            nodoSeleccionado = data.nodes.get(nodoSeleccionado[0]);
            nodoSeleccionado.inicio = true;
            nodoSeleccionado.color = colorInicio;
            data.nodes.update(nodoSeleccionado);
        }
    }

    function marcarFin() {
        let nodoSeleccionado = network.getSelectedNodes();
        let nodos = data.nodes.get();
        if(nodos.length > 0) {
            nodos.forEach(function (e) {
                e.fin = false;
                if(!e.inicio) {
                    e.color = colorComun;
                }
            });
        }

        data.nodes.update(nodos);

        if(nodoSeleccionado.length > 0) {
            nodoSeleccionado = data.nodes.get(nodoSeleccionado[0]);
            nodoSeleccionado.fin = true;
            nodoSeleccionado.color = colorFin;
            data.nodes.update(nodoSeleccionado);
        }
    }

    function setLabel(label) {
        $('#labelAyuda').html(label);
    }

    function getNodoInicial() {
        let nodo = null;

        data.nodes.forEach(function(e) {
            if(e.inicio) nodo = e;
        });

        return nodo;
    }

    function getNodoFinal() {
        let nodo = null;

        data.nodes.forEach(function(e) {
            if(e.fin) nodo = e;
        });

        return nodo;
    }

    function getHijos(nodo) {

    }

    function calcularRuta() {
        let nodoInicial = getNodoInicial();
        let nodoFinal = getNodoFinal();

        if(nodoInicial == null) {
            alert('Debe marcar un nodo como inicio');
            return;
        }

        if(nodoFinal == null) {
            alert('Debe marcar un nodo como fin');
            return;
        }

        alert('Todo ok, pero todavia no está implementado A*');

    }

    $(function() {

        $('.dropdown-toggle').on('click', function(event) {
            $('.dropdown-menu').slideToggle();
            event.stopPropagation();
        });

        $('.dropdown-menu').on('click', function(event) {
            event.stopPropagation();
        });

        $(window).on('click', function() {
            $('.dropdown-menu').slideUp();
        });

    });

    function setCalcularH(valor) {
        opciones.calcularH = valor;
        if(valor) {
            recalcularH();
        } else {
            borrarH();
        }
    }

    function recalcularH() {
        let nodoFinal = getNodoFinal();
        if(nodoFinal != null) {
            data.nodes.forEach(function (e) {
                if(e.id != nodoFinal.id) {
                    h = Math.sqrt(Math.pow((nodoFinal.x - e.x),2)+Math.pow((nodoFinal.y-e.y),2));
                } else {
                    h = 0;
                }
                e.h = h;
                e.label = e.id + ': ' + h;
            });
        }
    }

    function borrarH() {
        data.nodes.forEach(function(e) {
            if(!nodo.fin) {
                e.h = null;
                e.label = e.id + ': ??';
            }
        });
    }
</script>
</body>
</html>