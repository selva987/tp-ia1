<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TP IA 1 A*</title>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/all.min.css">

    <script src="js/vis-network.min.js"></script>
    <script src="js/NodoGrafo.js"></script>
    <script src="js/NodoArbol.js"></script>
    <script src="js/AEstrella.js"></script>
    <script src="js/grafos.js"></script>
    <script src="js/MiDataSet.js"></script>
    <script src="js/jquery-3.5.0.min.js"></script>
    <script src="js/bootstrap.bundle.min.js"></script>


</head>
<body>
<header>
    <nav class="navbar navbar-dark bg-dark shadow-sm">
        <div class="container d-flex justify-content-between">
            <a href="#" class="navbar-brand d-flex align-items-center">
                <strong>Búsqueda A<sup>*</sup></strong>
            </a>
            <ul class="navbar-nav mr-auto">
                <li class="nav-item active">
                    <span id="labelAyuda" class="nav-link">Click derecho sobre el area para ver acciones</span></span>
                </li>
            </ul>
            <ul class="nav justify-content-end">
                <li class="nav-item">
                    <button type="button" class="btn btn-outline-light" onclick="calcularRuta();">Calcular ruta</button>
                </li>
                <li class="nav-item dropdown">
                    <button id="botonConfig" class="btn btn-link nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false"><i class="fas fa-cog"></i></button>
                    <div class="dropdown-menu dropdown-menu-right" id="menu-config">
                        <div class="dropdown-item">
                            <span>Opciones</span>
                        </div>
                        <div class="dropdown-divider"></div>
                        <div class="dropdown-item">
                            <div class="custom-control custom-switch d-flex justify-content-between">
                                <input type="checkbox" autocomplete="off" class="custom-control-input" id="switchCalcularH" onclick="setCalcularH(this.checked)">
                                <label class="custom-control-label" for="switchCalcularH">Calcular h'</label>
                            </div>
<!--                            <div class="form-check d-flex justify-content-between">-->
<!--                                <input type="checkbox" autocomplete="off" class="form-check-input" id="switchCalcularH" onclick="setCalcularH(this.checked)">-->
<!--                                <label class="form-check-label" for="switchCalcularH">Calcular h'</label>-->
<!--                            </div>-->
                        </div>
                    </div>
                </li>
            </ul>
        </div>
    </nav>
</header>

<div class="row" style="height: 100%;">
    <div id="grafo" style="height: 100%; width: 33.33%;"></div>
    <div id="grafo2" style="height: 100%; width: 33.33%;"></div>
    <div id="grafo3" style="height: 100%; width: 33.33%;"></div>
</div>

<div>
<a style="display: none;" class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false"><i class="fas fa-cog"></i></a>
<div class="dropdown-menu dropdown-menu-sm" id="context-menu">
    <button id="agregar-nodo" class="btn btn-link dropdown-item" onclick="agregarNodo();">Agregar nodo</button>
    <button id="eliminar-nodo" class="btn btn-link dropdown-item" onclick="network.deleteSelected()">Eliminar nodo</button>
    <button id="marcar-inicio" class="btn btn-link dropdown-item" onclick="marcarInicio()">Marcar como inicio</button>
    <button id="marcar-fin" class="btn btn-link dropdown-item" onclick="marcarFin()">Marcar como fin</button>
    <button id="agregar-camino" class="btn btn-link dropdown-item" onclick="setLabel('Arrastre desde y hacia el nodo que quiera conectar');network.addEdgeMode()">Agregar camino</button>
    <button id="eliminar-camino" class="btn btn-link dropdown-item" onclick="network.deleteSelected()">Eliminar camino</button>
</div>
</div>

<script>

    //Opciones generales de la aplicación
    var opciones = {
        calcularH: false
    };

    //Cuando se presiona suprimir, se elimina lo que haya seleccionado
    $(document).keyup(function(ev) {
        if(ev.keyCode == 46) {
            network.deleteSelected();
        }
    });

    var menuX;
    var menuY;

    // ejemplo de nodos
    var nodes = new vis.DataSet([
        {id: 1, label: 'A'},
        {id: 2, label: 'B'},
        {id: 3, label: 'C'},
        {id: 4, label: 'D'},
        {id: 5, label: 'E'}
    ]);

    // ejemplo de caminos
    var edges = new vis.DataSet([
        {from: 1, to: 3, label: "30", color:"#5b5bff"},
        {from: 1, to: 2,label: "15", color: "#5b5bff"},
        {from: 2, to: 4,label: "100", color: "#5b5bff"},
        {from: 2, to: 5,label: "50", color: "#5b5bff"},
    ]);

    //Configuracion de la libreria
    var options = {
        autoResize: true,
        height: '100%',
        width: '100%',
        locale: 'es',
        // locales: locales,
        clickToUse: false,
        // configure: {enabled:true},    // defined in the configure module.
        edges: {
            color: {
                inherit: false,
                color:'#848484',
                highlight:'#848484',
            }
        },        // defined in the edges module.
        // nodes: {...},        // defined in the nodes module.
        // groups: {...},       // defined in the groups module.
        // layout: {...},       // defined in the layout module.
        // interaction: {...},  // defined in the interaction module.
        manipulation: {
            enabled: false,
            initiallyActive: false,
            addNode: function (node, callback) {
                //codigo legacy a menos que quisieramos utilizar botones
                setLabel('');
                let label = getLetraDisponible();
                if(label == null) return false;
                node.label = label;
                callback(node);
            },
            addEdge: function (edge, callback) {
                setLabel('');
                let peso = null;
                let arrNombre = [edge.from, edge.to];

                while(peso == null) {
                    peso = prompt('Ingrese el peso de la ruta, solo se admiten números enteros', 0);
                    if(!peso || peso == '0') {
                        network.disableEditMode();
                        return false;
                    }

                    peso = parseInt(peso);

                    if(!Number.isInteger(peso)) {
                        peso = null;
                    }
                }

                edge.label = peso.toString();
                edge.peso = peso;
                edge.id = arrNombre.sort().join('');

                if(data.edges.get(edge.id)) {
                    alert('Los nodos ya están conectados');
                    network.disableEditMode();
                    return false;
                }

                callback(edge);
            },
            editEdge: true,
            deleteNode: true,
            deleteEdge: true,
            controlNodeStyle:{
                // all node options are valid.
            }
        },
        // physics: {...},      // defined in the physics module.
        physics: {
            enabled: false,     // Stops node movement during display
            stabilization: {    // Determines an initial layout; enabled by default
                enabled: true,
                iterations: 1000
            }
        },
    };

    //Se inicializa la librería que va a servir para ingresar datos
    var container = document.getElementById('grafo');
    var container2 = document.getElementById('grafo2');
    var container3 = document.getElementById('grafo3');
    // var data = { //ejemplo
    //     nodes: nodes,
    //     edges: edges
    // };
    var data = {
        nodes: new MiDataSet( grafoHOptimo.nodes, function (e) {
            return new NodoGrafo(e.id, e.h, e.x, e.y, e.inicio, e.fin);
        }),
        edges: new vis.DataSet(grafoHOptimo.edges)
    };
    var data2 = {
        nodes2: new vis.DataSet(),
        edges2: new vis.DataSet()
    };
    var data3 = {
        nodes3: new vis.DataSet(),
        edges3: new vis.DataSet()
    };
    var network = new vis.Network(container, data, options);
    var network2 = new vis.Network(container2, data2, options);
    var network3 = new vis.Network(container3, data3, options);


    //Manejo del menu contextual que hicimos
    network.on("oncontext", function (params) {
        params.event.preventDefault();
        $('#context-menu button').hide();

        //Depende de donde se clickeo se va a seleccionar lo que haya y mostrar
        //las opciones adecuadas en el menu
        let nodoID = network.getNodeAt(params.pointer.DOM);
        if(typeof nodoID !== 'undefined') {
            network.selectNodes([nodoID]);
            $('#agregar-camino').show();
            $('#eliminar-nodo').show();
            $('#marcar-inicio').show();
            $('#marcar-fin').show();
        } else {
            let rutaID = network.getEdgeAt(params.pointer.DOM);
            if(typeof rutaID !== 'undefined') {
                network.selectEdges([rutaID]);
                $('#eliminar-camino').show();
            } else {
                $('#agregar-nodo').show();
                $('#agregar-camino').show();
            }
        }

        network.on('dragEnd', function(params){
            if(params.nodes.length > 0) {
                let nodes = data.nodes.get(params.nodes);
                nodes[0].x = params.pointer.canvas.x;
                nodes[0].y = params.pointer.canvas.y;

                data.nodes.update(nodes[0]);

                if(opciones.calcularH) {
                    recalcularH();
                }
            }
        });

        //Guardo las coordenadas para usarlas en otras funciones
        menuX = params.pointer.canvas.x;
        menuY = params.pointer.canvas.y;

        //Acomodo el menu donde tiene que ir y lo muestro
        $("#context-menu").finish().toggle(100);
        $("#context-menu").css({
            top: params.event.pageY + "px",
            left: params.event.pageX + "px"
        });
    });

    //Si hago click en otro lado escondo el menu
    network.on("click", function(params) {
        $("#context-menu").removeClass("show").hide();
    });
    $(document).on("click", function() {
        $("#context-menu").removeClass("show").hide();
    });


    function getLetraDisponible() {
        for(i=65;i<97;i++) {
            label = String.fromCharCode(i);
            let disponible = true;
            data.nodes.forEach(function(e) {
                if(e.id == label) {
                    disponible = false;
                    return false;
                }
            });
            if(disponible) return label;
        }
        return null

    }

    function getNodoByID(id) {
        let nodo = null;
        data.nodes.forEach(function(e) {
            if(e.id == id) {
                nodo = e;
            }
        });

        return nodo;
    }

    function agregarNodo() {
        let label = getLetraDisponible();

        let h = null;
        if(!opciones.calcularH) {
            h = prompt('Ingrese H', 0);
            if(h == null) return;
            h = parseInt(h);
        }

        let nodo = new NodoGrafo(label, h, menuX, menuY, false, false);
        data.nodes.add(nodo);

        if(opciones.calcularH) recalcularH();
    }

    function marcarInicio() {
        let nodoSeleccionado = network.getSelectedNodes();
        let nodos = data.nodes.get();
        if(nodos.length > 0) {
            nodos.forEach(function (e) {
                e.setInicio(false);
            });
        }

        data.nodes.update(nodos);

        if(nodoSeleccionado.length > 0) {
            nodoSeleccionado = data.nodes.get(nodoSeleccionado[0]);
            nodoSeleccionado.setInicio(true);
            data.nodes.update(nodoSeleccionado);
        }
    }

    function marcarFin() {
        let nodoSeleccionado = network.getSelectedNodes();
        let nodos = data.nodes.get();
        if(nodos.length > 0) {
            nodos.forEach(function (e) {
                e.setFin(false);
            });
        }

        data.nodes.update(nodos);

        if(nodoSeleccionado.length > 0) {
            nodoSeleccionado = data.nodes.get(nodoSeleccionado[0]);
            nodoSeleccionado.setFin(true);
            nodoSeleccionado.setH(0);
            data.nodes.update(nodoSeleccionado);
        }

        if(opciones.calcularH) recalcularH();
    }

    function setLabel(label) {
        $('#labelAyuda').html(label);
    }

    function getNodoInicial() {
        let nodo = null;
        data.nodes.forEach(function(e) {
            if(e.inicio) nodo = e;
        });

        return nodo;
    }

    function getNodoFinal() {
        let nodo = null;
        data.nodes.forEach(function(e) {
            if(e.fin) nodo = e;
        });

        return nodo;
    }

    function calcularRuta() {
        let nodoInicial = getNodoInicial();
        let nodoFinal = getNodoFinal();

        if(nodoInicial == null) {
            alert('Debe marcar un nodo como inicio');
            return;
        }

        if(nodoFinal == null) {
            alert('Debe marcar un nodo como fin');
            return;
        }

        var aEstrella = new AEstrella(data.nodes.get());
        aEstrella.resolver();

    }

    $(function() {

        $('#botonConfig').on('click', function(event) {
            $('#menu-config').slideToggle();
            event.stopPropagation();
        });

        $('#menu-config').on('click', function(event) {
            event.stopPropagation();
        });

        $(window).on('click', function() {
            $('#menu-config').slideUp();
        });

    });

    function setCalcularH(valor) {
        opciones.calcularH = valor;
        if(valor) {
            recalcularH();
        } else {
            borrarH();
        }
    }

    function recalcularH() {
        let nodoFinal = getNodoFinal();
        let nodos = data.nodes.get();
            nodos.forEach(function (e) {
                if(nodoFinal != null) {
                    if (e.id != nodoFinal.id) {
                        h = Math.sqrt(Math.pow((nodoFinal.x - e.x), 2) + Math.pow((nodoFinal.y - e.y), 2));
                    } else {
                        h = 0;
                    }
                    e.setH(parseInt(h));
                } else e.setH(null);


            });
            data.nodes.update(nodos);
    }

    function borrarH() {
        let nodos = data.nodes.get();
        nodos.forEach(function(e) {
            if(!e.fin) {
                e.setH(null);
            }
        });

        data.nodes.update(nodos);
    }

    $(document).ready(function() {
        if(opciones.calcularH) {
            $('#switchCalcularH').attr('checked', true);
        } else {
            $('#switchCalcularH').removeAttr('checked');
        }

    });

    function guardarComoJSON() {
        console.log(JSON.stringify({
            nodes: data.nodes.get(),
            edges: data.edges.get()
        }));
    }
</script>
</body>
</html>