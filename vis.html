<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TP IA 1 A*</title>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/all.min.css">

    <script src="js/vis-network.min.js"></script>
    <script src="js/jquery-3.5.0.min.js"></script>
    <script src="js/bootstrap.bundle.min.js"></script>


</head>
<body>
<header>
    <nav class="navbar navbar-dark bg-dark shadow-sm">
        <div class="container d-flex justify-content-between">
            <a href="#" class="navbar-brand d-flex align-items-center">
                <strong>Búsqueda A<sup>*</sup></strong>
            </a>
            <ul class="navbar-nav mr-auto">
                <li class="nav-item active">
                    <span id="labelAyuda" class="nav-link">Click derecho sobre el area para ver acciones</span></span>
                </li>
            </ul>
            <ul class="nav justify-content-end">
                <li class="nav-item">
                    <button type="button" class="btn btn-outline-light" onclick="calcularRuta();">Calcular ruta</button>
                </li>
                <li class="nav-item dropdown">
                    <button id="botonConfig" class="btn btn-link nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false"><i class="fas fa-cog"></i></button>
                    <div class="dropdown-menu dropdown-menu-right" id="menu-config">
                        <div class="dropdown-item">
                            <span>Opciones</span>
                        </div>
                        <div class="dropdown-divider"></div>
                        <div class="dropdown-item">
                            <div class="custom-control custom-switch d-flex justify-content-between">
                                <input type="checkbox" autocomplete="off" class="custom-control-input" id="switchCalcularH" onclick="setCalcularH(this.checked)">
                                <label class="custom-control-label" for="switchCalcularH">Calcular h'</label>
                            </div>
<!--                            <div class="form-check d-flex justify-content-between">-->
<!--                                <input type="checkbox" autocomplete="off" class="form-check-input" id="switchCalcularH" onclick="setCalcularH(this.checked)">-->
<!--                                <label class="form-check-label" for="switchCalcularH">Calcular h'</label>-->
<!--                            </div>-->
                        </div>
                    </div>
                </li>
            </ul>
        </div>
    </nav>
</header>

<div class="row" style="height: 100%;">
    <div class="card" style="height: 98%; width: 33%;">
        <div id="grafo" class="card-body"></div>
    </div>
    <div class="card" style="height: 98%; width: 33%;">
        <div id="arbol" class="card-body"></div>
    </div>
    <div class="card" style="height: 98%; width: 33%;">
        <div id="explicacion" class="card-body" style="overflow-y: auto"></div>
    </div>
</div>

<div>
<a style="display: none;" class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false"><i class="fas fa-cog"></i></a>
<div class="dropdown-menu dropdown-menu-sm" id="context-menu">
    <button id="agregar-nodo" class="btn btn-link dropdown-item" onclick="agregarNodo();">Agregar nodo</button>
    <button id="eliminar-nodo" class="btn btn-link dropdown-item" onclick="networkGrafo.deleteSelected()">Eliminar nodo</button>
    <button id="marcar-inicio" class="btn btn-link dropdown-item" onclick="marcarInicio()">Marcar como inicio</button>
    <button id="marcar-fin" class="btn btn-link dropdown-item" onclick="marcarFin()">Marcar como fin</button>
    <button id="agregar-camino" class="btn btn-link dropdown-item" onclick="setLabel('Arrastre desde y hacia el nodo que quiera conectar');networkGrafo.addEdgeMode()">Agregar camino</button>
    <button id="eliminar-camino" class="btn btn-link dropdown-item" onclick="networkGrafo.deleteSelected()">Eliminar camino</button>
</div>
</div>

<script>

    //Opciones generales de la aplicación
    var opciones = {
        calcularH: false
    };

    //Cuando se presiona suprimir, se elimina lo que haya seleccionado
    $(document).keyup(function(ev) {
        if(ev.keyCode == 46) {
            networkGrafo.deleteSelected();
        }
    });

    var menuX;
    var menuY;



    function getLetraDisponible() {
        for(i=65;i<97;i++) {
            label = String.fromCharCode(i);
            let disponible = true;
            dataGrafo.nodes.forEach(function(e) {
                if(e.id == label) {
                    disponible = false;
                    return false;
                }
            });
            if(disponible) return label;
        }
        return null

    }

    function getNodoByID(id) {
        let nodo = null;
        dataGrafo.nodes.forEach(function(e) {
            if(e.id == id) {
                nodo = e;
            }
        });

        return nodo;
    }

    function agregarNodo() {
        let label = getLetraDisponible();

        let h = null;
        if(!opciones.calcularH) {
            h = prompt('Ingrese H', 0);
            if(h == null) return;
            h = parseInt(h);
        }

        let nodo = new NodoGrafo(label, h, menuX, menuY, false, false);
        dataGrafo.nodes.add(nodo);

        if(opciones.calcularH) recalcularH();
    }

    function marcarInicio() {
        let nodoSeleccionado = networkGrafo.getSelectedNodes();
        let nodos = dataGrafo.nodes.get();
        if(nodos.length > 0) {
            nodos.forEach(function (e) {
                e.setInicio(false);
            });
        }

        dataGrafo.nodes.update(nodos);

        if(nodoSeleccionado.length > 0) {
            nodoSeleccionado = dataGrafo.nodes.get(nodoSeleccionado[0]);
            nodoSeleccionado.setInicio(true);
            dataGrafo.nodes.update(nodoSeleccionado);
        }
    }

    function marcarFin() {
        let nodoSeleccionado = networkGrafo.getSelectedNodes();
        let nodos = dataGrafo.nodes.get();
        if(nodos.length > 0) {
            nodos.forEach(function (e) {
                e.setFin(false);
            });
        }

        dataGrafo.nodes.update(nodos);

        if(nodoSeleccionado.length > 0) {
            nodoSeleccionado = dataGrafo.nodes.get(nodoSeleccionado[0]);
            nodoSeleccionado.setFin(true);
            nodoSeleccionado.setH(0);
            dataGrafo.nodes.update(nodoSeleccionado);
        }

        if(opciones.calcularH) recalcularH();
    }

    function setLabel(label) {
        $('#labelAyuda').html(label);
    }

    function getNodoInicial() {
        let nodo = null;
        dataGrafo.nodes.forEach(function(e) {
            if(e.inicio) nodo = e;
        });

        return nodo;
    }

    function getNodoFinal() {
        let nodo = null;
        dataGrafo.nodes.forEach(function(e) {
            if(e.fin) nodo = e;
        });

        return nodo;
    }

    function calcularRuta() {
        let nodoInicial = getNodoInicial();
        let nodoFinal = getNodoFinal();

        if(nodoInicial == null) {
            alert('Debe marcar un nodo como inicio');
            return;
        }

        if(nodoFinal == null) {
            alert('Debe marcar un nodo como fin');
            return;
        }

        var aEstrella = new AEstrella(dataGrafo.nodes.get());
        aEstrella.resolver();

    }

    $(function() {

        $('#botonConfig').on('click', function(event) {
            $('#menu-config').slideToggle();
            event.stopPropagation();
        });

        $('#menu-config').on('click', function(event) {
            event.stopPropagation();
        });

        $(window).on('click', function() {
            $('#menu-config').slideUp();
        });

    });

    function setCalcularH(valor) {
        opciones.calcularH = valor;
        if(valor) {
            recalcularH();
        } else {
            borrarH();
        }
    }

    function recalcularH() {
        let nodoFinal = getNodoFinal();
        let nodos = dataGrafo.nodes.get();
            nodos.forEach(function (e) {
                if(nodoFinal != null) {
                    if (e.id != nodoFinal.id) {
                        h = Math.sqrt(Math.pow((nodoFinal.x - e.x), 2) + Math.pow((nodoFinal.y - e.y), 2));
                    } else {
                        h = 0;
                    }
                    e.setH(parseInt(h));
                } else e.setH(null);


            });
            dataGrafo.nodes.update(nodos);
    }

    function borrarH() {
        let nodos = dataGrafo.nodes.get();
        nodos.forEach(function(e) {
            if(!e.fin) {
                e.setH(null);
            }
        });

        dataGrafo.nodes.update(nodos);
    }

    $(document).ready(function() {
        if(opciones.calcularH) {
            $('#switchCalcularH').attr('checked', true);
        } else {
            $('#switchCalcularH').removeAttr('checked');
        }

    });

    function guardarComoJSON() {
        console.log(JSON.stringify({
            nodes: dataGrafo.nodes.get(),
            edges: dataGrafo.edges.get()
        }));
    }
</script>
<script src="js/NodoGrafo.js"></script>
<script src="js/NodoArbol.js"></script>
<script src="js/AEstrella.js"></script>
<script src="js/grafos.js"></script>
<script src="js/MiDataSet.js"></script>
<script src="js/configGrafo.js"></script>
<script src="js/configArbol.js"></script>
</body>
</html>